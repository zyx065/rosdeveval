repository: autoware
language: C++
ros_package_file: src/universe/autoware.universe/vehicle/autoware_external_cmd_converter
ros_package: autoware_external_cmd_converter
file_path: src/node.cpp
method_name: ExternalCmdConverterNode::ExternalCmdConverterNode
requirement: |
  /**
  * @brief Constructs an ExternalCmdConverterNode for converting external vehicle control commands.
  * 
  * This node subscribes to external control commands and emergency stop signals, converts them 
  * to internal control commands using acceleration/brake mapping, and publishes the converted commands.
  * 
  * @param node_options Configuration options for initializing the ROS2 node.
  */
category: ros_architecture
type: has_timer,has_topic,has_diagnostics,has_parameter
signature: |
  ExternalCmdConverterNode::ExternalCmdConverterNode(const rclcpp::NodeOptions & node_options)
  : Node("external_cmd_converter", node_options)
additional_information:
  function_related_variable: |
    rclcpp::Publisher<Control>::SharedPtr cmd_pub_;
    rclcpp::Publisher<tier4_external_api_msgs::msg::ControlCommandStamped>::SharedPtr current_cmd_pub_;
    rclcpp::Subscription<tier4_external_api_msgs::msg::ControlCommandStamped>::SharedPtr control_cmd_sub_;
    rclcpp::Subscription<tier4_external_api_msgs::msg::Heartbeat>::SharedPtr emergency_stop_heartbeat_sub_;
    double ref_vel_gain_;  // reference velocity = current velocity + desired acceleration * gain
    bool wait_for_first_topic_;
    double control_command_timeout_;
    double emergency_stop_timeout_;
    AccelMap accel_map_;
    BrakeMap brake_map_;
    bool acc_map_initialized_;
    diagnostic_updater::Updater updater_{this};
    GearCommand::ConstSharedPtr current_shift_cmd_{nullptr};
  function_related_function: |
    void on_external_cmd(const ExternalControlCommand::ConstSharedPtr cmd_ptr);
    void on_emergency_stop_heartbeat(const tier4_external_api_msgs::msg::Heartbeat::ConstSharedPtr msg);
    void on_timer();
  function_related_class: |
    namespace autoware::raw_vehicle_cmd_converter
    {
    class AccelMap
    {
    public:
      bool readAccelMapFromCSV(const std::string & csv_path, const bool validation = false);
      bool getThrottle(const double acc, const double vel, double & throttle) const;
      bool getAcceleration(const double throttle, const double vel, double & acc) const;
      std::vector<double> getVelIdx() const { return vel_index_; }
      std::vector<double> getThrottleIdx() const { return throttle_index_; }
      std::vector<std::vector<double>> getAccelMap() const { return accel_map_; }

    private:
      rclcpp::Logger logger_{
        rclcpp::get_logger("autoware_raw_vehicle_cmd_converter").get_child("accel_map")};
      rclcpp::Clock clock_{RCL_ROS_TIME};
      std::string vehicle_name_;
      std::vector<double> vel_index_;
      std::vector<double> throttle_index_;
      std::vector<std::vector<double>> accel_map_;
    };
    }  // namespace autoware::raw_vehicle_cmd_converter

    namespace autoware::raw_vehicle_cmd_converter
    {
    class BrakeMap
    {
    public:
      bool readBrakeMapFromCSV(const std::string & csv_path, const bool validation = false);
      bool getBrake(const double acc, const double vel, double & brake);
      bool getAcceleration(const double brake, const double vel, double & acc) const;
      std::vector<double> getVelIdx() const { return vel_index_; }
      std::vector<double> getBrakeIdx() const { return brake_index_; }
      std::vector<std::vector<double>> getBrakeMap() const { return brake_map_; }

    private:
      rclcpp::Logger logger_{
        rclcpp::get_logger("autoware_raw_vehicle_cmd_converter").get_child("accel_map")};
      rclcpp::Clock clock_{RCL_ROS_TIME};
      std::string vehicle_name_;
      std::vector<double> vel_index_;
      std::vector<double> brake_index_;
      std::vector<double> brake_index_rev_;
      std::vector<std::vector<double>> brake_map_;
    };
    }  // namespace autoware::raw_vehicle_cmd_converter
test: test_autoware_external_cmd_converter
test_cases: []